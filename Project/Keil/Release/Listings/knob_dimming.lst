C51 COMPILER V9.60.7.0   KNOB_DIMMING                                                      05/12/2025 17:48:27 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE KNOB_DIMMING
OBJECT MODULE PLACED IN .\Release\Objects\knob_dimming.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\knob_dimming.c LARGE OPTIMIZE(8,SPEED) BROWSE INTVECTOR(0X000
                    -C) INCDIR(..\..\Libraries\Include;..\..\User) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\knob_dimming.lst) 
                    -OBJECT(.\Release\Objects\knob_dimming.obj)

line level    source

   1          #include "knob_dimming.h" // æ—‹é’®è°ƒå…‰å¤´æ–‡ä»¶
   2          
   3          volatile u16 limited_max_pwm_duty = 0; // å­˜æ”¾é™åˆ¶çš„æœ€å¤§å ç©ºæ¯”
   4          volatile u16 limited_adjust_pwm_duty;  // å­˜æ”¾æ—‹é’®é™åˆ¶ä¹‹åçš„ï¼Œå¾…è°ƒæ•´çš„å ç©ºæ¯”å€¼
   5          
   6          // æ ¹æ®æ—‹é’®ï¼Œé™åˆ¶å½“å‰çš„æœ€å¤§å ç©ºæ¯”
   7          void update_max_pwm_duty_coefficient(void)
   8          {
   9   1          volatile u16 adc_val = 0;
  10   1          adc_sel_pin(ADC_SEL_PIN_P31);
  11   1          adc_val = adc_get_val();
  12   1      
  13   1          // limited_max_pwm_duty = (u32)adjust_duty * adc_val / 4096; // ä¼šå‡ºç°æŒ‡æ•°çº§ä¸‹é™ï¼Œå› ä¸ºadjus
             -t_dutyä¸€ç›´åœ¨å˜åŒ–
  14   1          // limited_max_pwm_duty = (u32)MAX_PWM_DUTY * adc_val / 4096; // åˆ†çº§å¤ªå¤šï¼ŒåŠ ä¸ŠæŠ–åŠ¨å’Œè¿…é€Ÿå
             -˜åŒ–ï¼Œä¼šå¯¼è‡´ç¯å…‰é—ªçƒ
  15   1      
  16   1      #if 1
  17   1      
  18   1          // adå€¼æ˜¯å‡è®¾å‚è€ƒç”µå‹VCCä¸º4.87Vï¼Œè®¡ç®—å¾—å‡º
  19   1          if (adc_val <= KNOB_DIMMING_MIN_ADC_VAL) // MIN 0%  0.57V
  20   1          {
  21   2              limited_max_pwm_duty = 0;
  22   2          }
  23   1          // else if (adc_val <= 1278) // 20% 1.52V
  24   1          else if (adc_val <= 1245) // 20% 1.52V /* è¿™é‡Œç”¨5Vä½œä¸ºå‚è€ƒç”µå‹ */
  25   1          {
  26   2              // è®¡ç®—é‡‡é›†åˆ°çš„adå€¼æ‰€å 20%å¯¹åº”çš„adå€¼å¾—å æ¯”ï¼Œå†ä¹˜ä»¥ 20%çš„å ç©ºæ¯”
  27   2              /*
  28   2                  è®¡ç®—éªŒè¯ï¼Œè¿™é‡Œçš„adå€¼å¦‚æœåªç›¸å·®1ï¼Œå ç©ºæ¯”çš„å€¼ä¹Ÿåªç›¸å·®1
  29   2              */
  30   2              limited_max_pwm_duty = (u32)adc_val * MAX_PWM_DUTY * 2 / 10 / 1278;
  31   2          }
  32   1          // else if (adc_val <= 2498) // 40% 2.97V
  33   1          else if (adc_val <= 2286) // 40% 2.79V /* è¿™é‡Œç”¨5Vä½œä¸ºå‚è€ƒç”µå‹ */
  34   1          {
  35   2              /*
  36   2                  è®¡ç®—éªŒè¯ï¼Œè¿™é‡Œçš„adå€¼å¦‚æœåªç›¸å·®1ï¼Œå ç©ºæ¯”çš„å€¼ä¹Ÿåªç›¸å·®1
  37   2              */
  38   2              limited_max_pwm_duty = (u32)adc_val * MAX_PWM_DUTY * 4 / 10 / 2498;
  39   2          }
  40   1          // else if (adc_val <= 2641) // 50% 3.14V
  41   1          else if (adc_val <= 2834) // 50% 3.46V /* è¿™é‡Œç”¨5Vä½œä¸ºå‚è€ƒç”µå‹ */
  42   1          {
  43   2              // limited_max_pwm_duty = adc_val * MAX_PWM_DUTY * 5 / 10 / 2641;
  44   2              limited_max_pwm_duty = (u32)adc_val * MAX_PWM_DUTY / 2 / 2641;
  45   2          }
  46   1          // else if (adc_val <= 3482) // 60% 4.14V
  47   1          else if (adc_val <= 3260) // 60% 3.98V /* è¿™é‡Œç”¨5Vä½œä¸ºå‚è€ƒç”µå‹ */
  48   1          {
  49   2              limited_max_pwm_duty = (u32)adc_val * MAX_PWM_DUTY * 6 / 10 / 3482;
  50   2          }
  51   1          // else if (adc_val <= 4087) // 80% 4.86V
C51 COMPILER V9.60.7.0   KNOB_DIMMING                                                      05/12/2025 17:48:27 PAGE 2   

  52   1          else if (adc_val <= KNOB_DIMMING_MAX_ADC_VAL) // 
  53   1          {
  54   2              limited_max_pwm_duty = (u32)adc_val * MAX_PWM_DUTY * 8 / 10 / 4087;
  55   2          }
  56   1          else
  57   1          {
  58   2              // limited_max_pwm_duty = (u32)adc_val * MAX_PWM_DUTY / 4095;
  59   2              limited_max_pwm_duty = MAX_PWM_DUTY;
  60   2          }
  61   1      
  62   1          limited_adjust_pwm_duty = (u32)adjust_duty * limited_max_pwm_duty / MAX_PWM_DUTY; // adjust_duty * æ—‹
             -é’®é™åˆ¶çš„å ç©ºæ¯”ç³»æ•°
  63   1      
  64   1          if (limited_adjust_pwm_duty >= 5950) // å¤§äºè¯¥å€¼ï¼Œç›´æ¥è¾“å‡ºæœ€å¤§åŠŸç‡ï¼Œé˜²æ­¢ä»MINæ‰­åˆ°MA
             -Xæ—¶ï¼Œè¾“å‡ºä¸äº†æœ€å¤§åŠŸç‡
  65   1          {
  66   2              limited_adjust_pwm_duty = adjust_duty;
  67   2          }
  68   1      
  69   1      #if USE_MY_DEBUG
              
                  // printf("cur_level %u\n", knob_dimming_cur_level);
              
              #endif // #if USE_MY_DEBUG
  74   1      
  75   1      #endif
  76   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    356    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      4       2
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
